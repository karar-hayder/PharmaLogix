{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <h2>Cashier System</h2>
    
    <!-- Search Section -->
    <div class="search-section">
        <input type="text" id="product-search" class="form-control" placeholder="Search for medications..." autocomplete="off">
        <div id="search-results" class="search-results">
            <!-- Search results will be dynamically populated here -->
        </div>
    </div>

    <!-- Cart Section -->
    <div id="cart-container" class="cart-container mt-4">
        <h3>Cart</h3>
        <div id="cart-items">
            <!-- Cart items will be dynamically updated here via JS -->
        </div>
        <p><strong>Total:</strong> $<span id="total-price">0.00</span></p>
    </div>

    <!-- Payment Section -->
    <div class="payment-section mt-4">
    <div class="form-group">
        <label for="discount">Discount</label>
        <input type="number" step="250" id="discount" name="discount" class="form-control" placeholder="Enter discount amount" value=0>
    </div>
    <div class="form-group">
        <label for="payment-received">Payment Received</label>
        <input type="number" step="250" id="payment-received" name="payment_received" class="form-control" required value=0>
    </div>
    <button onclick="checkout()" class="btn btn-primary mt-3">Complete Sale</button>
    <p id="checkout-message" class="mt-3 text-success" style="display: none;">Sale completed successfully!</p>
</div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Function to get a cookie by name
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Pass the pharmacy ID from the Django context
    const pharmacyId = "{{ pharmacy.id }}";  

    // Add event listener to the search input field
    document.getElementById('product-search').addEventListener('keyup', function() {
        searchMedications();
    });

    // Function to search for medications
    function searchMedications() {
        const query = document.getElementById('product-search').value;

        if (query.length > 2) {
            fetch(`/api/pharmacy/${pharmacyId}/search/?q=${encodeURIComponent(query)}`)  // Ensure the URL is correct
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const searchResults = document.getElementById('search-results');
                    searchResults.innerHTML = ''; // Clear previous results

                    data.forEach(item => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-item');
                        resultItem.innerHTML = `
                            ${item.medication_name} [${item.generic_name}] - $${item.price} (Stock: ${item.stock_level})
                            <button onclick="addToCart(${item.id})">Add to Cart</button>
                        `;
                        searchResults.appendChild(resultItem);
                    });
                })
                .catch(error => console.error('Error fetching search results:', error));
        }
    }

    // Add product to cart by product ID
    function addToCart(productId) {
        fetch(`/api/pharmacy/${pharmacyId}/cart/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),  // Include CSRF token
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.message) {
                updateCartView(); // Update cart after successfully adding an item
            }
        })
        .catch(error => console.error('Error adding to cart:', error));
    }
    function removeFromCart(productId) {
        fetch(`/api/pharmacy/${pharmacyId}/cart/${productId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),  // Include CSRF token
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                updateCartView(); // Refresh the cart view after removing the item
            } else {
                console.error('Error removing item from cart:', response.statusText);
            }
        })
        .catch(error => console.error('Error removing from cart:', error));
    }

    // Update the cart view for the pharmacy
    function updateCartView() {
        fetch(`/api/pharmacy/${pharmacyId}/cart/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const cartContainer = document.getElementById('cart-items');
                cartContainer.innerHTML = ''; // Clear current cart items

                data.cart_items.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.classList.add('cart-item');
                    cartItem.innerHTML = `
                        <p>${item.product.medication_name} - $${item.total_price} (x${item.quantity})</p>
                        <button onclick="removeFromCart(${item.product.id})" class="btn btn-danger">Remove</button>
                    `;
                    cartContainer.appendChild(cartItem);
                });

                // Update total price
                document.getElementById('total-price').innerText = data.total_price;
            })
            .catch(error => console.error('Error updating cart view:', error));
    }

    // Complete the sale (checkout)
    function checkout() {
        const paymentReceived = document.getElementById('payment-received').value;
        const discount = document.getElementById('discount').value; // Get discount value
    
        fetch(`/api/pharmacy/${pharmacyId}/checkout/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),  // Include CSRF token
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                payment_received: paymentReceived,
                discount: discount // Include discount in the request body
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                alert(data.error); // Show error if payment is insufficient
            } else {
                document.getElementById('checkout-message').style.display = 'block';
                document.getElementById('payment-received').value = 0; // Reset payment received
                document.getElementById('discount').value = 0; // Reset discount input
                
                updateCartView(); // Clear the cart after checkout
            }
        })
        .catch(error => console.error('Error during checkout:', error));
    }
</script>

{% endblock scripts %}