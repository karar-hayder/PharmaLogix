{% extends "base.html" %}
{% load static %}

{% block head %}
<title>Medication Management</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'core/css/barcode_add.css' %}">
{% endblock head %}

{% block content %}

<div class='medication-management'>
<h1>Medication Management</h1>


<h2>Scan Medication Barcode</h2>
<video id="video" width="300" height="200" style="border: 1px solid gray"></video>
<p>Scanned Barcode: <span id="scanned-barcode">None</span></p>
<p id="barcode-result"></p>

<!-- Form for Updating Medications -->
<h2>Update Medication</h2>
<form id="update-medication-form">
    <label for="search">Search Name:</label>
    <input type="text" id="search" name="search" placeholder="Enter name" required>
    <button type="button" id="search-button">Search</button>
</form>

<div id="search-results"></div>

<!-- Edit Medication Modal -->
<div id="edit-modal" style="display:none;">
    <div class="modal-content">
        <h3>Edit Medication</h3>
        <form id="edit-medication-form">
            <input type="hidden" id="medication-pk" name="medication-pk">
            
            <label for="edit-barcode">Barcode:</label>
            <input type="text" id="edit-barcode" name="barcode"><br>

            <label for="edit-name">Name:</label>
            <input type="text" id="edit-name" name="name"><br>

            <label for="edit-generic-name">Generic Name:</label>
            <input type="text" id="edit-generic-name" name="generic_name"><br>

            <label for="edit-manufacturer">Manufacturer:</label>
            <input type="text" id="edit-manufacturer" name="manufacturer"><br>

            <label for="edit-dosage-form">Dosage Form:</label>
            <input type="text" id="edit-dosage-form" name="dosage_form"><br>

            <label for="edit-strength">Strength:</label>
            <input type="text" id="edit-strength" name="strength"><br>

            <label for="edit-active-ingredients">Active Ingredients:</label>
            <input type="text" id="edit-active-ingredients" name="active_ingredients"><br>

            <button type="submit">Update Medication</button>
        </form>
    </div>
</div>

<!-- Form for Creating New Medications -->
<h2>Create Medication</h2>
<form id="create-medication-form">
    <label for="create-barcode">Barcode:</label>
    <input type="text" id="create-barcode" name="barcode" required><br>

    <label for="create-name">Name:</label>
    <input type="text" id="create-name" name="name" required><br>

    <label for="create-generic-name">Generic Name:</label>
    <input type="text" id="create-generic-name" name="generic_name"><br>

    <label for="create-manufacturer">Manufacturer:</label>
    <input type="text" id="create-manufacturer" name="manufacturer"><br>

    <label for="create-dosage-form">Dosage Form:</label>
    <input type="text" id="create-dosage-form" name="dosage_form"><br>

    <label for="create-strength">Strength:</label>
    <input type="text" id="create-strength" name="strength"><br>

    <label for="create-active-ingredients">Active Ingredients:</label>
    <input type="text" id="create-active-ingredients" name="active_ingredients"><br>

    <button type="submit">Create Medication</button>
</form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getCSRFToken() {
        let csrfToken = null;
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const trimmedCookie = cookie.trim();
            if (trimmedCookie.startsWith('csrftoken=')) {
                csrfToken = trimmedCookie.substring('csrftoken='.length);
                break;
            }
        }
        return csrfToken;
    }

    // Add CSRF token to AJAX requests
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type))) {
                xhr.setRequestHeader('X-CSRFToken', getCSRFToken());
            }
        }
    });
    let searchTimeout = null;

    // Perform live search on keyup
    $('#search').on('keyup', function() {
        clearTimeout(searchTimeout);  // Clear previous timeout

        const searchQuery = $(this).val();  // Get the current input value
        
        // Only search if 3 or more characters are typed
        if (searchQuery.length >= 3) {
            searchTimeout = setTimeout(function() {
                $.ajax({
                    url: '/api/medication/search/',  // Adjust this URL as needed
                    data: { name: searchQuery },  // Sending search query as a parameter
                    success: function(data) {
                        $('#search-results').empty();  // Clear previous results

                        if (data.length > 0) {
                            data.forEach(medication => {
                                $('#search-results').append(`
                                    <div>
                                        <p>${medication.name} (${medication.barcode})</p>
                                        <button class="edit-button" data-pk="${medication.pk}" data-name="${medication.name}">Edit</button>
                                    </div>
                                `);
                            });
                        } else {
                            $('#search-results').append('<p>No medications found.</p>');
                        }
                    },
                    error: function() {
                        alert('Error searching for medications');
                    }
                });
            }, 300);  // Wait 300ms after the user stops typing before sending the request
        } else {
            $('#search-results').empty();  // Clear results if less than 3 characters
        }
    });

    // Handle loading medication data for editing
    $(document).on('click', '.edit-button', function() {
        const medicationPk = $(this).data('pk');  // Get the pk from the button's data attribute
    
        $.ajax({
            url: `/api/medication/search/`,  // URL to the search API
            method: 'GET',
            data: { pk: medicationPk },  // Send the medication pk as the query parameter
            success: function(response) {
                if (response.length > 0) {
                    const medication = response[0];  // Since response is a list, we get the first result
    
                    // Populate the form fields with the medication data
                    $('#medication-pk').val(medication.pk);
                    $('#edit-barcode').val(medication.barcode);
                    $('#edit-name').val(medication.name);
                    $('#edit-generic-name').val(medication.generic_name);
                    $('#edit-manufacturer').val(medication.manufacturer);
                    $('#edit-dosage-form').val(medication.dosage_form);
                    $('#edit-strength').val(medication.strength);
                    $('#edit-active-ingredients').val(medication.active_ingredients);
    
                    // Show the edit modal or form
                    $('#edit-modal').show();
                } else {
                    alert('No medication found.');
                }
            },
            error: function() {
                alert('Error loading medication data for editing.');
            }
        });
    });
    

    // Handle updating medication
    $('#edit-medication-form').on('submit', function(e) {
        e.preventDefault();
        const medicationpk = $('#medication-pk').val();  // Get the medication ID
        const formData = {
            medication_id: medicationpk,
            barcode: $('#edit-barcode').val(),
            name: $('#edit-name').val(),
            generic_name: $('#edit-generic-name').val(),
            manufacturer: $('#edit-manufacturer').val(),
            dosage_form: $('#edit-dosage-form').val(),
            strength: $('#edit-strength').val(),
            active_ingredients: $('#edit-active-ingredients').val(),
        };
    
        $.ajax({
            url: `{% url 'Barcode add' %}`,  // PUT request for updating the medication
            method: 'PUT',
            contentType: 'application/json',  // Ensure we're sending JSON data
        data: JSON.stringify(formData),  // Convert data to JSON string
        success: function(data) {
            alert('Medication updated successfully.');
            location.reload();  // Reload the page to reflect changes
        },
        error: function(xhr) {
            alert('Error updating medication: ' + xhr.responseText);
        }
    });
    });
    

    // Handle creating new medication
    $('#create-medication-form').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            url: '{% url "Med create" %}',  // Update with your create URL
            method: 'POST',
            data: $(this).serialize(),
            success: function(data) {
                alert('Medication created successfully.');
                location.reload();  // Reload the page to see the new data
            },
            error: function(xhr) {
                alert('Error creating medication: ' + xhr.responseJSON.error);
            }
        });
    });
</script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
    const codeReader = new ZXing.BrowserMultiFormatReader(); 
    const videoElement = document.getElementById('video'); 
    const resultElement = document.getElementById('scanned-barcode'); 
    const resultMessage = document.getElementById('barcode-result'); 

    
    function sendBarcode(code) {
        fetch(`/api/medication/search/?barcode=${encodeURIComponent(code)}`) 
            .then(response => {
                if (!response.ok) {
                    
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.length > 0) {
                    
                    resultMessage.innerText = `Medication found: ${data[0].name} (${data[0].strength}) [${data[0].manufacturer}] | ${data[0].barcode} |`;
                } else {
                    
                    resultMessage.innerText = "No medication found with that barcode.";
                }
            })
            .catch(error => {
                console.error('Error fetching medication:', error);
                resultMessage.innerText = "Error fetching medication: " + error.message; 
            });
        }

    
    function startScanning() {
        codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
            if (result && result.text.length >= 10) {
                resultElement.innerText = `${result.text}`; 
                sendBarcode(result.text); 
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error(err); 
            }
        });
    }

    
    startScanning();

</script>


{% endblock scripts %}
